<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>CN IP 节点处理工具</title>
<style>
body {
    background: #0d1117;
    color: #c9d1d9;
    font-family: Consolas, monospace;
    margin: 0;
    padding: 20px;
}
.container {
    max-width: 1200px;
    margin: auto;
}
.card {
    background: #161b22;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}
h2, h3 {
    color: #58a6ff;
}
textarea {
    width: 100%;
    height: 80px;
    background: #0d1117;
    color: #c9d1d9;
    border: 1px solid #30363d;
    border-radius: 4px;
    padding: 8px;
}
button {
    background: #238636;
    border: none;
    padding: 10px 25px;
    font-size: 16px;
    color: white;
    border-radius: 5px;
    cursor: pointer;
}
button:hover {
    background: #2ea043;
}
pre {
    background: #010409;
    border: 1px solid #30363d;
    padding: 10px;
    overflow: auto;
    max-height: 200px;
}
.step {
    margin-top: 10px;
}
.count {
    font-size: 18px;
    color: #3fb950;
}
</style>
</head>
<body>

<div class="container">

<h2>CN IP 节点筛选 & 格式化工具</h2>

<div class="card">
<h3>RAW 地址（每行一个）</h3>
<textarea id="urls">
https://raw.githubusercontent.com/papapapapdelesia/Emilia/main/Data/alive.txt
</textarea>
<br><br>
<button onclick="run()">开始处理</button>
</div>

<div class="card step"><h3>Step 1 - 原始数据</h3><pre id="s1"></pre></div>
<div class="card step"><h3>Step 2 - 筛选 ,CN,</h3><pre id="s2"></pre></div>
<div class="card step"><h3>Step 3 - 去除 ,CN, 后内容</h3><pre id="s3"></pre></div>
<div class="card step"><h3>Step 4 - IP:PORT</h3><pre id="s4"></pre></div>
<div class="card step"><h3>Step 5 - IP:PORT#</h3><pre id="s5"></pre></div>
<div class="card step"><h3>Step 6 - API 请求地址</h3><pre id="s6"></pre></div>
<div class="card step"><h3>Step 7 - 最终输出</h3><pre id="s7"></pre></div>

<div class="count" id="count"></div>

</div>

<script>
async function run() {
    const urls = document.getElementById("urls").value
        .split("\n")
        .map(u => u.trim())
        .filter(Boolean);

    let rawLines = [];

    // Step 1 - 拉取原始数据
    for (const url of urls) {
        const txt = await fetch(url).then(r => r.text());
        rawLines.push(...txt.split("\n").filter(Boolean));
    }
    document.getElementById("s1").textContent = rawLines.join("\n");

    // Step 2 - 精确筛选 ,CN,
    const cnLines = rawLines.filter(l => l.includes(",CN,"));
    document.getElementById("s2").textContent = cnLines.join("\n");

    // Step 3 - 构建完整对象（关键）
    const nodes = cnLines.map(line => {
        const parts = line.split(",");
        return {
            ip: parts[0],
            port: parts[1],
            origin: parts.slice(3).join(",").trim()
        };
    });

    document.getElementById("s3").textContent =
        nodes.map(n => `${n.ip},${n.port}`).join("\n");

    // Step 4
    const step4 = nodes.map(n => `${n.ip}:${n.port}`);
    document.getElementById("s4").textContent = step4.join("\n");

    // Step 5
    document.getElementById("s5").textContent =
        step4.map(l => l + "#").join("\n");

    // Step 6 - API 请求
    const ipList = nodes.map(n => n.ip).join(",");
    const apiUrl = "https://api.proxynova.com/v1/geolocation/bulk?ip=" + ipList;
    document.getElementById("s6").textContent = apiUrl;

    let geoMap = {};
    try {
        const json = await fetch(apiUrl).then(r => r.json());
        json.data?.forEach(d => geoMap[d.ip] = d);
    } catch {}

    // Step 7 - 最终拼接（修复点）
    const final = nodes.map((n, i) => {
        const geo = geoMap[n.ip];
        const index = i + 1;

        let region = geo?.region || "CN";
        let city = geo?.city || "未知";

        let line = `${n.ip}:${n.port}#${region}${index} ${city}中转`;

        if (n.origin) {
            line += ` ${n.origin}`;
        }

        return line;
    });

    document.getElementById("s7").textContent = final.join("\n");
    document.getElementById("count").textContent =
        `共输出节点数：${final.length}`;
}
</script>

</body>
</html>